name: Build and Release

permissions:
  contents: write

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install

      - name: Build
        run: npm run build

      - name: Copy assets to dist (Modo Seguro)
        run: |
          # Crear directorios necesarios para que la PS4 no falle
          mkdir -p dist/download0/payloads
          mkdir -p dist/download0/img

          # Copiar Payloads si existen
          if [ -d "src/download0/payloads" ]; then
            cp src/download0/payloads/*.elf dist/download0/payloads/ 2>/dev/null || true
            cp src/download0/payloads/*.bin dist/download0/payloads/ 2>/dev/null || true
          fi

          # Copiar Imágenes base (sin forzar subcarpetas borradas)
          if [ -d "src/download0/img" ]; then
            cp -r src/download0/img/* dist/download0/img/ 2>/dev/null || true
          fi
          
          # Copiar archivos encriptados .aes
          cp src/download0/*.aes dist/download0/ 2>/dev/null || true

      - name: Encrypt savedata
        run: |
          pip install cryptography
          # Solo encripta si el archivo existe
          if [ -f "src/savedata/localstorage" ]; then
            python src/tools/encrypt_aes_files.py src/savedata/localstorage || true
            mkdir -p dist/savedata
            [ -f "src/savedata/localstorage.aes" ] && cp src/savedata/localstorage.aes dist/savedata/ || true
          fi

      - name: Upload dist artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  ufs-image:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download dist artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Create UFS2 image (Fix CE-30001-4)
        uses: vmactions/freebsd-vm@v1
        with:
          release: "14.2"
          copyback: true
          run: |
            set -e
            # 1. Crear el contenedor de 256MB
            dd if=/dev/zero of=download0.bin bs=1M count=256
            
            # 2. Configurar dispositivo
            MD=$(mdconfig -a -t vnode -f download0.bin)
            
            # 3. Formatear UFS2 (Obligatorio para PS4)
            newfs -O 2 -b 32768 -f 4096 /dev/${MD}
            mount /dev/${MD} /mnt
            
            # 4. Copiar contenido DIRECTAMENTE a la raíz del disco
            # Esto evita el error de "Application Problem"
            cp -R dist/download0/* /mnt/
            
            # 5. Crear carpetas de sistema que Vue espera encontrar
            mkdir -p /mnt/mgl /mnt/video_cache /mnt/xhr_cache
            
            # 6. Permisos totales
            chmod -R 777 /mnt
            
            umount /mnt
            mdconfig -d -u ${MD}

      - name: Upload download0.bin
        uses: actions/upload-artifact@v4
        with:
          name: download0.bin
          path: download0.bin