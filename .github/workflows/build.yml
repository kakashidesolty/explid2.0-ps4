name: Build and Release

permissions:
  contents: write

on:
  push:
    branches: [main]
  release:
    types: [created]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install

      - name: Build
        run: npm run build

      - name: Replace version string with commit hash
        run: find ./dist -type f -name '*.js' -exec sed -i "s/%VERSION_STRING%/${{ github.sha }}/g" {} +

      - name: Copy assets to dist (Anti-Error)
        run: |
          # Crear directorios base para que no fallen los comandos cp
          mkdir -p dist/download0/payloads
          mkdir -p dist/download0/img

          # Copiar archivos solo si existen (evita el error que detiene el build)
          [ -d src/download0/payloads ] && cp src/download0/payloads/*.elf dist/download0/payloads/ 2>/dev/null || true
          [ -d src/download0/payloads ] && cp src/download0/payloads/*.bin dist/download0/payloads/ 2>/dev/null || true
          [ -d src/download0/img ] && cp -r src/download0/img/* dist/download0/img/ 2>/dev/null || true
          
          # Copiar archivos .aes de la raíz de download0
          cp src/download0/*.aes dist/download0/ 2>/dev/null || true

          # NOTA: No intentamos copiar sfx ni vid porque ya no existen.

      - name: Encrypt savedata
        run: |
          pip install cryptography
          # Solo ejecuta el script si existe la carpeta savedata y el archivo localstorage
          if [ -f src/savedata/localstorage ]; then
            python src/tools/encrypt_aes_files.py src/savedata/localstorage || true
            mkdir -p dist/savedata
            [ -f src/savedata/localstorage.aes ] && cp src/savedata/localstorage.aes dist/savedata/ || true
          fi

      - name: Zip dist
        run: cd dist && zip -r ../vue-after-free-${{ github.event.repository.name }}.zip .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  ufs-image:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download dist artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Create UFS2 image in FreeBSD
        uses: vmactions/freebsd-vm@v1
        with:
          release: "14.2"
          copyback: true
          prepare: ""
          run: |
            set -e
            # Crear el archivo vacío de 256MB
            dd if=/dev/zero of=download0.bin bs=1M count=256
            MD=$(mdconfig -a -t vnode -f download0.bin)
            newfs -O 2 -b 32768 -f 4096 /dev/${MD}
            mount /dev/${MD} /mnt
            
            # Copiar el contenido generado en el paso anterior
            cp -R dist/download0/* /mnt/
            
            # Crear carpetas temporales necesarias por el sistema PS4
            mkdir -p /mnt/mgl /mnt/video_cache /mnt/xhr_cache
            chmod -R 777 /mnt/*
            umount /mnt
            mdconfig -d -u ${MD}

      - name: Upload UFS image
        uses: actions/upload-artifact@v4
        with:
          name: download0.bin
          path: download0.bin