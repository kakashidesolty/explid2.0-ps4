name: Build and Release

permissions:
  contents: write

on:
  push:
    branches: [main]
  release:
    types: [created]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install

      - name: Build
        run: npm run build

      - name: Replace version string with commit hash
        run: find ./dist -type f -name '*.js' -exec sed -i "s/%VERSION_STRING%/${{ github.sha }}/g" {} +

      - name: Copy assets to dist (Modificado para no fallar)
        run: |
          # Solo copiamos si las carpetas existen
          mkdir -p dist/download0/payloads
          [ -d src/download0/payloads ] && cp src/download0/payloads/*.elf dist/download0/payloads/ || true
          [ -d src/download0/payloads ] && cp src/download0/payloads/*.bin dist/download0/payloads/ || true
          [ -d src/download0/img ] && cp -r src/download0/img dist/download0/ || true
          [ -d src/download0/*.aes ] && cp src/download0/*.aes dist/download0/ || true
          # Eliminamos el intento de copiar sfx y vid para evitar el error

      - name: Encrypt savedata
        run: |
          pip install cryptography
          # Usamos || true para que no falle si no tienes la carpeta savedata
          python src/tools/encrypt_aes_files.py src/savedata/localstorage || true
          mkdir -p dist/savedata
          [ -f src/savedata/localstorage.aes ] && cp src/savedata/localstorage.aes dist/savedata/ || true

      - name: Zip dist
        run: cd dist && zip -r ../vue-after-free-${{ github.event.repository.name }}.zip .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  ufs-image:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download dist artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Create UFS2 image in FreeBSD
        uses: vmactions/freebsd-vm@v1
        with:
          release: "14.2"
          copyback: true
          prepare: ""
          run: |
            set -e
            # 1. Crear el archivo de 256MB
            dd if=/dev/zero of=download0.bin bs=1M count=256
            MD=$(mdconfig -a -t vnode -f download0.bin)
            newfs -O 2 -b 32768 -f 4096 /dev/${MD}
            mount /dev/${MD} /mnt
            # 2. Copiar solo lo que hay en dist/download0
            cp -R dist/download0/* /mnt/
            mkdir -p /mnt/mgl /mnt/video_cache /mnt/xhr_cache
            chmod -R 777 /mnt/*
            umount /mnt
            mdconfig -d -u ${MD}

      - name: Verify image size
        run: ls -lh download0.bin && du -sh download0.bin

      - name: Upload UFS image
        uses: actions/upload-artifact@v4
        with:
          name: download0.bin
          path: download0.bin